<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Narapoi</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#0b0b0b;color:#fff;padding:16px}
.wrap{max-width:480px;margin:auto;display:flex;flex-direction:column;gap:16px}
h2,h3{margin-bottom:8px}
input,textarea,button{border:none;border-radius:10px;padding:10px;color:#fff;background:#161616;font-size:14px}
textarea{resize:none;min-height:40px}
button{cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-weight:600;transition:.2s}
button:hover{opacity:.85}
.downloads-container{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
.download-row{display:flex;gap:6px;align-items:center;background:#222;padding:6px;border-radius:8px;cursor:grab}
.download-row input{flex:1;font-size:13px;padding:6px;border-radius:6px}
.download-row button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#ff3b3b;padding:4px;border-radius:6px}
.download-row .menu-btn{width:28px;height:28px;background:#555;border-radius:6px;font-size:16px;display:flex;align-items:center;justify-content:center}
.preview-btn{background:#2563eb;padding:12px;border-radius:10px;margin-top:6px;font-weight:600;text-align:center;min-height:50px;display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:flex-start;white-space:pre-wrap}
.row{display:flex;gap:6px;margin-top:4px;flex-wrap:wrap}
.row button{flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:8px;font-size:13px}
.dragging{opacity:.5}
.history-card{background:#111;padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:6px;margin-bottom:6px;word-break:break-word}
.link-container{display:flex;gap:6px;margin-bottom:8px}
.link-container textarea{flex:1;font-size:13px;padding:6px;border-radius:6px;min-height:40px}
@media(max-width:500px){
  .wrap{padding:12px}
  input,textarea,button{font-size:13px}
  .download-row input{font-size:12px}
  .row button{font-size:12px;padding:6px}
  .preview-btn{font-size:13px;padding:10px;min-height:45px}
}
video{max-width:100%;border-radius:10px;background:#000}
.preview-download-btn{background:#3b82f6;color:#fff;padding:6px 10px;border-radius:6px;margin-top:4px;cursor:pointer;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h2>Admin Narapoi</h2>

  <input id="id" placeholder="ID video (contoh: ngik)">
  <input id="title" placeholder="Judul video">
  <input id="src" placeholder="Link video (.mp4 / m3u8)">

  <div>Tombol Download</div>
  <div class="downloads-container" id="downloads"></div>
  <button onclick="addDownload()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
      <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
    </svg>
    Tambah tombol download
  </button>

  <button onclick="save()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
      <path d="M5 5V19H19V5H5ZM17 17H7V7H17V17Z"/>
    </svg>
    Generate
  </button>

  <div>Link hasil:</div>
  <div class="link-container">
    <textarea id="link" readonly></textarea>
    <button onclick="copyLink()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
        <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM20 7H8C6.9 7 6 7.9 6 9V21C6 22.1 6.9 23 8 23H20C21.1 23 22 22.1 22 21V9C22 7.9 21.1 7 20 7ZM20 21H8V9H20V21Z"/>
      </svg>
      Salin
    </button>
  </div>

  <div>Preview</div>
  <div id="preview" class="preview-btn">Player muncul di sini</div>

  <h3>History</h3>
  <div id="history"></div>
</div>

<script>
/* === Semua logic JS asli tetap sama, tidak dihapus/diubah === */
const $ = id=>document.getElementById(id);
let dragged=null;

function addDownload(label='', url=''){
  const d=document.createElement('div');
  d.className='download-row';
  d.draggable=true;
  d.innerHTML=`
    <div class="menu-btn" onclick="moveDownload(this)">⋮</div>
    <input placeholder="Judul" value="${label}">
    <input placeholder="Link" value="${url}">
    <button onclick="this.parentNode.remove()">
      &times;
    </button>`;
  d.addEventListener('dragstart',()=>{dragged=d;d.classList.add('dragging')});
  d.addEventListener('dragend',()=>d.classList.remove('dragging'));
  d.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=getDragAfterElement($('downloads'), e.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  d.addEventListener('touchstart',()=>{dragged=d;});
  d.addEventListener('touchmove',e=>{
    const touch=e.touches[0];
    const after=getDragAfterElement($('downloads'), touch.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  $('downloads').appendChild(d);
}

// Pindah posisi tombol download via titik tiga
function moveDownload(el){
  const row=el.parentNode;
  const container=$('downloads');
  const index=[...container.children].indexOf(row);
  const move=prompt("Ketik 'up' untuk pindah atas, 'down' untuk pindah bawah","");
  if(move==='up' && index>0) container.insertBefore(row, container.children[index-1]);
  if(move==='down' && index<container.children.length-1) container.insertBefore(row, container.children[index+1].nextSibling);
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.download-row:not(.dragging)')];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-(box.top+box.height/2);
    if(offset<0 && offset>closest.offset) return {offset:offset,element:child};
    return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}
addDownload();

function save(){
  let id=$('id').value.trim();
  const title=$('title').value.trim();
  const src=$('src').value.trim();
  if(!title||!src) return alert('Lengkapi semua field');
  if(!id) id='vid_'+Date.now().toString(36);

  const downloads=[];
  document.querySelectorAll('.download-row').forEach(r=>{
    if(r.children[2].value) downloads.push({label:r.children[1].value||'Download',url:r.children[2].value});
  });
  if(!downloads.length) downloads.push({label:'Download',url:src});

  const data={[id]:{title,src,downloads}};
  fetch('/videos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
  .then(()=>{
    $('link').value=location.origin+'/?v='+id;
    renderPreview(data[id]);
    saveHistory(data,id);
    alert('Tersimpan!');
  });
}

// Render preview sekarang video + tombol download
function renderPreview(v){
  $('preview').innerHTML='';
  const video=document.createElement('video');
  video.src=v.src;
  video.controls=true;
  video.autoplay=false;
  $('preview').appendChild(video);
  v.downloads.forEach(d=>{
    const btn=document.createElement('button');
    btn.textContent=d.label;
    btn.className='preview-download-btn';
    btn.onclick=()=>window.open(d.url,'_blank');
    $('preview').appendChild(btn);
  });
}

/* === Logic history tetap sama === */
function copyLink(){ $('link').select(); navigator.clipboard.writeText($('link').value); alert('Link disalin'); }

function saveHistory(data,id){
  let h=JSON.parse(localStorage.getItem('history')||'[]');
  h.unshift(data);
  localStorage.setItem('history',JSON.stringify(h.slice(0,10)));
  renderHistory();
}
function renderHistory(){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  $('history').innerHTML='';
  h.forEach((o,i)=>{
    const k=Object.keys(o)[0],v=o[k];
    const div=document.createElement('div');
    div.className='history-card';
    div.innerHTML=`<b>${k}</b> — ${v.title}
      <div class="row">
        <button onclick="previewHistory(${i})">Preview</button>
        <button onclick="editHistory(${i})">Edit</button>
        <button onclick="delHistory(${i})">Hapus</button>
      </div>`;
    $('history').appendChild(div);
  });
}
function previewHistory(i){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const k=Object.keys(h[i])[0],v=h[i][k];
  $('id').value=k; $('title').value=v.title; $('src').value=v.src;
  $('downloads').innerHTML='';
  v.downloads.forEach(d=>addDownload(d.label,d.url));
  $('link').value=location.origin+'/?v='+k;
  renderPreview(v);
}
function editHistory(i){ previewHistory(i); }
function delHistory(i){
  let h=JSON.parse(localStorage.getItem('history')||'[]'); h.splice(i,1);
  localStorage.setItem('history',JSON.stringify(h));
  renderHistory();
}

renderHistory();
</script>
</body>
</html>
