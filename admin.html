<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Narapoi</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#0b0b0b;color:#fff;padding:16px}
.wrap{max-width:480px;margin:auto;display:flex;flex-direction:column;gap:12px}
input,textarea,button{border:none;border-radius:10px;padding:10px;color:#fff;background:#161616}
textarea{resize:none}
button{cursor:pointer;background:#3b82f6;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px}
.downloads-container{display:flex;flex-direction:column;gap:6px}
.download-row{display:flex;gap:6px;align-items:center;background:#222;padding:6px;border-radius:8px;cursor:grab}
.download-row input{flex:1}
.download-row button{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#ff3b3b;padding:6px;border-radius:6px}
.preview-btn{background:#2563eb;padding:12px;border-radius:10px;margin-top:6px;font-weight:600;text-align:center}
.row{display:flex;gap:6px;margin-top:4px}
.row button{flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:8px}
.dragging{opacity:.5}
.history-card{background:#111;padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:4px;margin-bottom:6px}
.link-container{display:flex;gap:6px}
.link-container textarea{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h2>Admin Narapoi</h2>

  <input id="id" placeholder="ID video (contoh: ngik)">
  <input id="title" placeholder="Judul video">
  <input id="src" placeholder="Link video (.mp4 / m3u8)">

  <div>Tombol Download</div>
  <div class="downloads-container" id="downloads"></div>
  <button onclick="addDownload()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
      <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
    </svg>
    Tambah tombol download
  </button>

  <button onclick="save()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
      <path d="M5 5V19H19V5H5ZM17 17H7V7H17V17Z"/>
    </svg>
    Simpan
  </button>

  <div>Link hasil:</div>
  <div class="link-container">
    <textarea id="link" readonly></textarea>
    <button onclick="copyLink()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
        <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM20 7H8C6.9 7 6 7.9 6 9V21C6 22.1 6.9 23 8 23H20C21.1 23 22 22.1 22 21V9C22 7.9 21.1 7 20 7ZM20 21H8V9H20V21Z"/>
      </svg>
      Salin
    </button>
  </div>

  <div>Preview</div>
  <div id="preview" class="preview-btn">Player muncul di sini</div>

  <h3>History</h3>
  <div id="history"></div>
</div>

<script>
const $ = id=>document.getElementById(id);
let dragged=null;

function addDownload(label='', url=''){
  const d=document.createElement('div');
  d.className='download-row';
  d.draggable=true;
  d.innerHTML=`
    <input placeholder="Judul" value="${label}">
    <input placeholder="Link" value="${url}">
    <button onclick="this.parentNode.remove()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12Z"/>
      </svg>
    </button>`;
  d.addEventListener('dragstart',()=>{dragged=d;d.classList.add('dragging')});
  d.addEventListener('dragend',()=>d.classList.remove('dragging'));
  d.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=getDragAfterElement($('downloads'), e.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  d.addEventListener('touchstart',()=>{dragged=d;});
  d.addEventListener('touchmove',e=>{
    const touch=e.touches[0];
    const after=getDragAfterElement($('downloads'), touch.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  $('downloads').appendChild(d);
}
function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.download-row:not(.dragging)')];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-(box.top+box.height/2);
    if(offset<0 && offset>closest.offset) return {offset:offset,element:child};
    return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}
addDownload();

function save(){
  let id=$('id').value.trim();
  const title=$('title').value.trim();
  const src=$('src').value.trim();
  if(!title||!src) return alert('Lengkapi semua field');
  if(!id) id='vid_'+Date.now().toString(36);

  const downloads=[];
  document.querySelectorAll('.download-row').forEach(r=>{
    if(r.children[1].value) downloads.push({label:r.children[0].value||'Download',url:r.children[1].value});
  });
  if(!downloads.length) downloads.push({label:'Download',url:src});

  const data={[id]:{title,src,downloads}};
  fetch('/videos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
  .then(()=>{
    $('link').value=location.origin+'/?v='+id;
    renderPreview(data[id]);
    saveHistory(data,id);
    alert('Tersimpan!');
  });
}

function copyLink(){ $('link').select(); navigator.clipboard.writeText($('link').value); alert('Link disalin'); }

function renderPreview(v){ $('preview').textContent=`Judul: ${v.title}\nLink player: ${v.src}\nDownload: ${v.downloads.map(d=>d.label).join(', ')}`; }

function saveHistory(data,id){
  let h=JSON.parse(localStorage.getItem('history')||'[]');
  h.unshift(data);
  localStorage.setItem('history',JSON.stringify(h.slice(0,10)));
  renderHistory();
}
function renderHistory(){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  $('history').innerHTML='';
  h.forEach((o,i)=>{
    const k=Object.keys(o)[0],v=o[k];
    const div=document.createElement('div');
    div.className='history-card';
    div.innerHTML=`<b>${k}</b> â€” ${v.title}
      <div class="row">
        <button onclick="previewHistory(${i})">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff"><path d="M8 5v14l11-7z"/></svg> Preview
        </button>
        <button onclick="editHistory(${i})">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg> Edit
        </button>
        <button onclick="delHistory(${i})">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="#fff"><path d="M16 9v10H8V9h8m-1.5-6H9.5l-1 1H5v2h14V4h-3.5l-1-1z"/></svg> Hapus
        </button>
      </div>`;
    $('history').appendChild(div);
  });
}
function previewHistory(i){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const k=Object.keys(h[i])[0],v=h[i][k];
  $('id').value=k; $('title').value=v.title; $('src').value=v.src;
  $('downloads').innerHTML='';
  v.downloads.forEach(d=>addDownload(d.label,d.url));
  $('link').value=location.origin+'/?v='+k;
  renderPreview(v);
}
function editHistory(i){ previewHistory(i); }
function delHistory(i){
  let h=JSON.parse(localStorage.getItem('history')||'[]'); h.splice(i,1);
  localStorage.setItem('history',JSON.stringify(h));
  renderHistory();
}

renderHistory();
</script>
</body>
</html>
