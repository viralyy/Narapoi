<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Narapoi</title>

  <style>
    :root{
      --bg:#0a0a0a;
      --surface:#141414;
      --surface-2:#1a1a1a;
      --surface-hover:#222;
      --accent:#3b82f6;
      --accent-dark:#2563eb;
      --danger:#dc2626;
      --text:#f0f0f0;
      --text-dim:#a0a0a0;
      --border:#2a2a2a;
      --radius:14px;
      --gap:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(59,130,246,.08), transparent 60%),
        radial-gradient(900px 700px at 100% 0%, rgba(255,255,255,.04), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      padding:16px 12px;
      min-height:100vh;
      line-height:1.5;
    }

    .container{
      max-width:560px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    h1{
      font-size:1.9rem;
      letter-spacing:.2px;
    }

    h3{
      font-size:1.05rem;
      color:#e7e7e7;
      margin-top:8px;
    }

    /* Section cards */
    #downloads,
    .link-output,
    #preview,
    #history{
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }

    /* Inputs */
    input, textarea{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: #fff;
      font-size: 15px;
    }

    input::placeholder, textarea::placeholder{
      color: rgba(255,255,255,.38);
    }

    input:focus, textarea:focus{
      outline:none;
      border-color: rgba(59,130,246,.65);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }

    /* Buttons */
    button{
      width:100%;
      background: rgba(255,255,255,.05);
      color:#fff;
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 12px 14px;
      font-size: 14.5px;
      font-weight: 700;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:.18s;
    }

    button:hover{ background: rgba(255,255,255,.08); }

    button.primary{
      background: linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      border-color: rgba(255,255,255,.08);
      box-shadow: 0 12px 30px rgba(59,130,246,.18);
    }

    button.primary:hover{ filter: brightness(1.05); }

    button.danger{
      background: rgba(220,38,38,.92);
      border-color: rgba(255,255,255,.10);
    }

    /* DOWNLOAD ROW */
    .download-row{
      display:grid;
      grid-template-columns: 40px 1fr 1fr 40px;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      padding:10px;
      border-radius: 12px;
      margin-bottom:10px;
      user-select:none;
      touch-action:manipulation;
    }

    .download-row.dragging{
      opacity:.72;
      transform: scale(.99);
      box-shadow: 0 14px 38px rgba(0,0,0,.55);
    }

    .handle{
      width:40px;
      height:40px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:grab;
      flex-shrink:0;
    }

    .handle:active{ cursor:grabbing; }

    .download-row input{
      height:40px;
      padding:10px 12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      font-size:14px;
    }

    .download-row button{
      width:40px;
      height:40px;
      padding:0;
      font-size:18px;
      border-radius: 10px;
      background: rgba(220,38,38,.95);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Link output */
    .link-output{
      display:flex;
      gap:10px;
      align-items:stretch;
    }

    .link-output textarea{
      flex:1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13.5px;
      resize:none;
      height: 54px;
    }

    .link-output button{
      width:120px;
    }

    /* Preview */
    .preview-area{
      background: rgba(0,0,0,.55);
      border-radius: var(--radius);
      padding: 12px;
      min-height: 140px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:hidden;
    }

    .preview-area video{
      width:100%;
      max-height: 280px;
      border-radius: 12px;
      background:#111;
    }

    .preview-download-btn{
      width:100%;
      background: rgba(59,130,246,.95);
      border:1px solid rgba(255,255,255,.10);
      padding: 12px;
      border-radius: 12px;
      font-weight: 800;
      text-align:center;
      cursor:pointer;
    }

    /* History */
    .history-card{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .history-actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }

    .history-actions button{
      padding: 10px 0;
      font-size: 13.5px;
      width:100%;
    }

    /* Mobile */
    @media (max-width: 540px){
      body{ padding: 14px 10px; }
      h1{ font-size: 1.75rem; }

      .download-row{
        grid-template-columns: 40px 1fr 40px;
        grid-template-areas:
          "handle title remove"
          "handle url   remove";
        gap:10px;
      }

      .download-row .handle{ grid-area: handle; }
      .download-row input:nth-of-type(1){ grid-area: title; }
      .download-row input:nth-of-type(2){ grid-area: url; }
      .download-row button{ grid-area: remove; }

      .link-output{ flex-direction:column; }
      .link-output button{ width:100%; }

      .history-actions{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Admin Narapoi</h1>

    <input id="id" placeholder="ID video (kosong = auto generate)" />
    <input id="title" placeholder="Judul video" />
    <input id="src" placeholder="Link video (.mp4 atau m3u8)" />

    <h3>Tombol Download</h3>
    <div id="downloads"></div>

    <button onclick="addDownload()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path>
      </svg>
      Tambah tombol download
    </button>

    <button class="primary" onclick="save()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path>
      </svg>
      Generate & Simpan
    </button>

    <h3>Link Hasil</h3>
    <div class="link-output">
      <textarea id="link" readonly placeholder="Link akan muncul setelah generate"></textarea>
      <button onclick="copyLink()">Salin</button>
    </div>

    <h3>Preview</h3>
    <div id="preview" class="preview-area">
      <div style="color:#777; text-align:center; padding:50px 0; font-size:14px;">
        Video + tombol download akan muncul di sini
      </div>
    </div>

    <h3>History Terakhir</h3>
    <div id="history"></div>
  </div>

  <script>
    // ──────────────────────────────────────────────
    // Semua logic JS asli kamu (hanya tambah drag improvement)
    // ──────────────────────────────────────────────

    const $ = id => document.getElementById(id);
    let dragged = null;

    function addDownload(label = '', url = '') {
      const d = document.createElement('div');
      d.className = 'download-row';
      d.draggable = true;

      d.innerHTML = `
        <div class="handle">☰</div>
        <input placeholder="Judul tombol" value="${label}">
        <input placeholder="Link download" value="${url}">
        <button onclick="this.parentNode.remove()">×</button>
      `;

      // Drag & drop events (bisa drag dari mana saja di row)
      d.addEventListener('dragstart', () => {
        dragged = d;
        d.classList.add('dragging');
      });

      d.addEventListener('dragend', () => {
        d.classList.remove('dragging');
        dragged = null;
      });

      d.addEventListener('dragover', e => {
        e.preventDefault();
        const after = getDragAfterElement($('downloads'), e.clientY);
        if (!after) $('downloads').appendChild(dragged);
        else $('downloads').insertBefore(dragged, after);
      });

      // Touch support (mobile drag & drop)
      let touchStartY = 0;
      d.addEventListener('touchstart', e => {
        dragged = d;
        d.classList.add('dragging');
        touchStartY = e.touches[0].clientY;
      }, { passive: true });

      d.addEventListener('touchmove', e => {
        if (!dragged) return;
        e.preventDefault();
        const touchY = e.touches[0].clientY;
        const after = getDragAfterElement($('downloads'), touchY);
        if (!after) $('downloads').appendChild(dragged);
        else $('downloads').insertBefore(dragged, after);
      }, { passive: false });

      d.addEventListener('touchend', () => {
        d.classList.remove('dragging');
        dragged = null;
      });

      $('downloads').appendChild(d);
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.download-row:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Optional: menu up/down via handle (kalau mau pakai prompt)
    function moveDownload(el) {
      const row = el.parentNode;
      const container = $('downloads');
      const index = [...container.children].indexOf(row);
      const move = prompt("Ketik 'up' atau 'down'", "");
      if (move === 'up' && index > 0) {
        container.insertBefore(row, container.children[index - 1]);
      }
      if (move === 'down' && index < container.children.length - 1) {
        container.insertBefore(row, container.children[index + 1].nextSibling);
      }
    }

    // Tambah satu baris kosong saat load
    addDownload();

    // ──────────────────────────────────────────────
    // Sisanya sama persis seperti kode asli kamu
    // ──────────────────────────────────────────────

    function save() {
      let id = $('id').value.trim();
      const title = $('title').value.trim();
      const src = $('src').value.trim();
      if (!title || !src) return alert('Lengkapi judul dan link video');
      if (!id) id = 'vid_' + Date.now().toString(36);

      const downloads = [];
      document.querySelectorAll('.download-row').forEach(r => {
        const labelInput = r.children[1];
        const urlInput = r.children[2];
        if (urlInput.value.trim()) {
          downloads.push({
            label: labelInput.value.trim() || 'Download',
            url: urlInput.value.trim()
          });
        }
      });
      if (!downloads.length) downloads.push({ label: 'Download', url: src });

      const data = { [id]: { title, src, downloads } };

      fetch('/videos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(() => {
        $('link').value = location.origin + '/?v=' + id;
        renderPreview(data[id]);
        saveHistory(data, id);
        alert('Berhasil disimpan!');
      })
      .catch(err => alert('Gagal menyimpan: ' + err.message));
    }

    function renderPreview(v) {
      $('preview').innerHTML = '';
      const video = document.createElement('video');
      video.src = v.src;
      video.controls = true;
      video.autoplay = false;
      $('preview').appendChild(video);

      v.downloads.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'preview-download-btn';
        btn.textContent = d.label;
        btn.onclick = () => window.open(d.url, '_blank');
        $('preview').appendChild(btn);
      });
    }

    function copyLink() {
      const link = $('link');
      link.select();
      navigator.clipboard.writeText(link.value);
      alert('Link disalin!');
    }

    function saveHistory(data, id) {
      let h = JSON.parse(localStorage.getItem('history') || '[]');
      h.unshift(data);
      localStorage.setItem('history', JSON.stringify(h.slice(0, 10)));
      renderHistory();
    }

    function renderHistory() {
      const h = JSON.parse(localStorage.getItem('history') || '[]');
      $('history').innerHTML = '';
      h.forEach((o, i) => {
        const key = Object.keys(o)[0];
        const val = o[key];
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML = `
          <strong>${key}</strong> — ${val.title}
          <div class="history-actions">
            <button onclick="previewHistory(${i})">Preview</button>
            <button onclick="editHistory(${i})">Edit</button>
            <button class="danger" onclick="delHistory(${i})">Hapus</button>
          </div>
        `;
        $('history').appendChild(card);
      });
    }

    function previewHistory(i) {
      const h = JSON.parse(localStorage.getItem('history') || '[]');
      const key = Object.keys(h[i])[0];
      const v = h[i][key];
      $('id').value = key;
      $('title').value = v.title;
      $('src').value = v.src;
      $('downloads').innerHTML = '';
      v.downloads.forEach(d => addDownload(d.label, d.url));
      $('link').value = location.origin + '/?v=' + key;
      renderPreview(v);
    }

    function editHistory(i) { previewHistory(i); }

    function delHistory(i) {
      let h = JSON.parse(localStorage.getItem('history') || '[]');
      h.splice(i, 1);
      localStorage.setItem('history', JSON.stringify(h));
      renderHistory();
    }

    renderHistory();
  </script>
</body>
</html>
