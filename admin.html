<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Narapoi</title>

  <style>
    :root {
      --bg: #0b0b0b;
      --surface: #161616;
      --surface-2: #222;
      --surface-3: #2a2a2a;
      --text: #e0e0e0;
      --text-dim: #a0a0a0;
      --accent: #3b82f6;
      --accent-dark: #2563eb;
      --danger: #ef4444;
      --border: #333;
      --radius: 10px;
      --gap: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      padding: 16px;
      min-height: 100vh;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    h1, h2, h3 {
      color: white;
    }

    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.35rem; margin-bottom: 0.5rem; }
    h3 { font-size: 1.15rem; margin: 1rem 0 0.5rem; }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input, textarea {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      color: white;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      background: var(--surface-2);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--surface-3);
      transform: translateY(-1px);
    }

    button.primary   { background: var(--accent); }
    button.primary:hover { background: var(--accent-dark); }
    button.danger    { background: var(--danger); }
    button.danger:hover { background: #dc2626; }

    .download-row {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--surface-2);
      padding: 8px 10px;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
    }

    .download-row.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .download-row input {
      flex: 1;
      font-size: 14px;
      padding: 8px 10px;
    }

    .menu-btn {
      width: 32px;
      height: 32px;
      background: #444;
      border-radius: 6px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .download-row button {
      width: 32px;
      height: 32px;
      padding: 0;
      font-size: 18px;
      background: var(--danger);
    }

    .preview-area {
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      padding: 12px;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .preview-area video {
      width: 100%;
      border-radius: 8px;
      background: #111;
    }

    .preview-download-btn {
      background: var(--accent);
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
    }

    .link-output {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .link-output textarea {
      flex: 1;
      font-family: monospace;
      font-size: 14px;
    }

    .history-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .history-actions button {
      flex: 1;
      min-width: 100px;
      padding: 10px;
    }

    @media (max-width: 520px) {
      body { padding: 12px; }
      .container { gap: 14px; }
      button, input, textarea { font-size: 14px; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Admin Narapoi</h1>

  <div class="input-group">
    <input id="id"    placeholder="ID video (contoh: ngik)" />
    <input id="title" placeholder="Judul video" />
    <input id="src"   placeholder="Link video (.mp4 / m3u8)" />
  </div>

  <h3>Tombol Download</h3>
  <div id="downloads" class="downloads-container"></div>

  <button onclick="addDownload()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
      <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
    </svg>
    Tambah tombol download
  </button>

  <button class="primary" onclick="save()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
      <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
    </svg>
    Generate & Simpan
  </button>

  <h3>Link Hasil</h3>
  <div class="link-output">
    <textarea id="link" readonly placeholder="Link akan muncul di sini setelah generate"></textarea>
    <button onclick="copyLink()">Salin</button>
  </div>

  <h3>Preview</h3>
  <div id="preview" class="preview-area">
    <div style="color:#666; text-align:center; padding:40px 0;">
      Video player + tombol download akan muncul di sini
    </div>
  </div>

  <h3>History (terakhir 10)</h3>
  <div id="history"></div>
</div>

<!-- === JavaScript ASLI kamu (tidak diubah sama sekali) === -->
<script>
/* === Semua logic JS asli tetap sama, tidak dihapus/diubah === */
const $ = id=>document.getElementById(id);
let dragged=null;

function addDownload(label='', url=''){
  const d=document.createElement('div');
  d.className='download-row';
  d.draggable=true;
  d.innerHTML=`
    <div class="menu-btn" onclick="moveDownload(this)">⋮</div>
    <input placeholder="Judul" value="${label}">
    <input placeholder="Link" value="${url}">
    <button onclick="this.parentNode.remove()">
      ×
    </button>`;
  d.addEventListener('dragstart',()=>{dragged=d;d.classList.add('dragging')});
  d.addEventListener('dragend',()=>d.classList.remove('dragging'));
  d.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=getDragAfterElement($('downloads'), e.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  d.addEventListener('touchstart',()=>{dragged=d;});
  d.addEventListener('touchmove',e=>{
    const touch=e.touches[0];
    const after=getDragAfterElement($('downloads'), touch.clientY);
    if(!after) $('downloads').appendChild(dragged);
    else $('downloads').insertBefore(dragged, after);
  });
  $('downloads').appendChild(d);
}

function moveDownload(el){
  const row=el.parentNode;
  const container=$('downloads');
  const index=[...container.children].indexOf(row);
  const move=prompt("Ketik 'up' untuk pindah atas, 'down' untuk pindah bawah","");
  if(move==='up' && index>0) container.insertBefore(row, container.children[index-1]);
  if(move==='down' && index<container.children.length-1) container.insertBefore(row, container.children[index+1].nextSibling);
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.download-row:not(.dragging)')];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-(box.top+box.height/2);
    if(offset<0 && offset>closest.offset) return {offset:offset,element:child};
    return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}
addDownload();  // tambah 1 baris kosong awal

function save(){
  let id=$('id').value.trim();
  const title=$('title').value.trim();
  const src=$('src').value.trim();
  if(!title||!src) return alert('Lengkapi semua field');
  if(!id) id='vid_'+Date.now().toString(36);

  const downloads=[];
  document.querySelectorAll('.download-row').forEach(r=>{
    if(r.children[2].value) downloads.push({label:r.children[1].value||'Download',url:r.children[2].value});
  });
  if(!downloads.length) downloads.push({label:'Download',url:src});

  const data={[id]:{title,src,downloads}};
  fetch('/videos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
  .then(()=>{
    $('link').value=location.origin+'/?v='+id;
    renderPreview(data[id]);
    saveHistory(data,id);
    alert('Tersimpan!');
  });
}

function renderPreview(v){
  $('preview').innerHTML='';
  const video=document.createElement('video');
  video.src=v.src;
  video.controls=true;
  video.autoplay=false;
  $('preview').appendChild(video);
  v.downloads.forEach(d=>{
    const btn=document.createElement('button');
    btn.textContent=d.label;
    btn.className='preview-download-btn';
    btn.onclick=()=>window.open(d.url,'_blank');
    $('preview').appendChild(btn);
  });
}

function copyLink(){ 
  $('link').select(); 
  navigator.clipboard.writeText($('link').value); 
  alert('Link disalin'); 
}

function saveHistory(data,id){
  let h=JSON.parse(localStorage.getItem('history')||'[]');
  h.unshift(data);
  localStorage.setItem('history',JSON.stringify(h.slice(0,10)));
  renderHistory();
}

function renderHistory(){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  $('history').innerHTML='';
  h.forEach((o,i)=>{
    const k=Object.keys(o)[0],v=o[k];
    const div=document.createElement('div');
    div.className='history-card';
    div.innerHTML=`<strong>${k}</strong> — ${v.title}
      <div class="history-actions">
        <button onclick="previewHistory(${i})">Preview</button>
        <button onclick="editHistory(${i})">Edit</button>
        <button class="danger" onclick="delHistory(${i})">Hapus</button>
      </div>`;
    $('history').appendChild(div);
  });
}

function previewHistory(i){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const k=Object.keys(h[i])[0],v=h[i][k];
  $('id').value=k; 
  $('title').value=v.title; 
  $('src').value=v.src;
  $('downloads').innerHTML='';
  v.downloads.forEach(d=>addDownload(d.label,d.url));
  $('link').value=location.origin+'/?v='+k;
  renderPreview(v);
}

function editHistory(i){ previewHistory(i); }

function delHistory(i){
  let h=JSON.parse(localStorage.getItem('history')||'[]'); 
  h.splice(i,1);
  localStorage.setItem('history',JSON.stringify(h));
  renderHistory();
}

renderHistory();
</script>

</body>
</html>
