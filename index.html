<script>
/* ================= CONFIG ================= */
const FIREBASE =
  'https://views-counter-610fa-default-rtdb.asia-southeast1.firebasedatabase.app';

const id = new URLSearchParams(location.search).get('v');
let allowPlay = false;

/* ================= VALIDASI ID ================= */
if (!id) {
  document.body.innerHTML = 'Video tidak ditemukan';
  throw '';
}

/* ================= FETCH VIDEO ================= */
fetch('/videos?id=' + id)
  .then(res => {
    if (!res.ok) throw 'notfound';
    return res.json();
  })
  .then(v => {
    initPlayer(v);
    initProgress();
    initControls(v);
    initViews();
    initOnline();
  })
  .catch(() => {
    document.body.innerHTML = 'Video tidak tersedia';
  });

/* ================= INIT PLAYER ================= */
function initPlayer(v) {
  app.classList.remove('hidden');
  title.textContent = v.title;
  player.src = v.src;

  player.addEventListener('play', () => {
    if (!allowPlay) {
      allowPlay = true;
      // showAd();
    }
  });
}

/* ================= PROGRESS BAR ================= */
function initProgress() {
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progress');
  const handle = document.getElementById('handle');
  const tooltip = document.getElementById('tooltip');

  const formatTime = s => {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  };

  function updateUI() {
    const pct = (player.currentTime / player.duration) * 100 || 0;
    progressBar.style.width = pct + '%';
    handle.style.left = pct + '%';
    tooltip.style.left = pct + '%';
    tooltip.textContent = formatTime(player.currentTime);
  }

  player.addEventListener('timeupdate', updateUI);

  /* DRAG HANDLE */
  let dragging = false;

  handle.addEventListener('mousedown', e => {
    dragging = true;
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const rect = progressContainer.getBoundingClientRect();
    let pct = (e.clientX - rect.left) / rect.width;
    pct = Math.max(0, Math.min(1, pct));
    player.currentTime = pct * player.duration;
    updateUI();
  });

  document.addEventListener('mouseup', () => (dragging = false));

  /* TOOLTIP */
  progressContainer.addEventListener('mousemove', e => {
    const rect = progressContainer.getBoundingClientRect();
    let pct = (e.clientX - rect.left) / rect.width;
    pct = Math.max(0, Math.min(1, pct));
    tooltip.style.display = 'block';
    tooltip.style.left = pct * 100 + '%';
    tooltip.textContent = formatTime(pct * player.duration);
  });

  progressContainer.addEventListener(
    'mouseleave',
    () => (tooltip.style.display = 'none')
  );
}

/* ================= CONTROLS ================= */
function initControls(v) {
  playBtn.onclick = () => {
    player.paused ? player.play() : player.pause();
    playBtn.classList.toggle('playing', !player.paused);
  };

  rewind.onclick = () =>
    (player.currentTime = Math.max(0, player.currentTime - 5));

  forward.onclick = () =>
    (player.currentTime = Math.min(
      player.duration,
      player.currentTime + 5
    ));

  fs.onclick = () =>
    !document.fullscreenElement
      ? player.requestFullscreen()
      : document.exitFullscreen();

  speed.onchange = e =>
    (player.playbackRate = parseFloat(e.target.value));

  /* FULL KONTEN */
  openFull.onclick = () => {
    popupBox.innerHTML = '';
    (v.downloads || []).forEach(d => {
      const a = document.createElement('a');
      a.href = d.url;
      a.target = '_blank';
      a.textContent = d.label;
      popupBox.appendChild(a);
    });
    popup.classList.add('show');
  };

  document.querySelector('.popup-bg').onclick = () =>
    popup.classList.remove('show');
}

/* ================= VIEWS ================= */
function initViews() {
  fetch(`${FIREBASE}/views/${id}.json`)
    .then(r => r.json())
    .then(data => {
      if (typeof data === 'number') {
        fetch(`${FIREBASE}/views/${id}.json`, {
          method: 'PUT',
          body: JSON.stringify(data + 1),
        });
      } else {
        fetch(`${FIREBASE}/views/${id}/${Date.now()}.json`, {
          method: 'PUT',
          body: 1,
        });
      }
    });

  setInterval(() => {
    fetch(`${FIREBASE}/views/${id}.json`)
      .then(r => r.json())
      .then(d => {
        const total =
          typeof d === 'number' ? d : d ? Object.keys(d).length : 0;
        views.textContent = total + ' views';
      });
  }, 3000);
}

/* ================= ONLINE ================= */
function initOnline() {
  const sid = Math.random().toString(36).slice(2);

  setInterval(() => {
    fetch(`${FIREBASE}/online/${id}/${sid}.json`, {
      method: 'PUT',
      body: Date.now(),
    });

    fetch(`${FIREBASE}/online/${id}.json`)
      .then(r => r.json())
      .then(d => {
        let count = 0;
        const now = Date.now();
        for (let k in d) {
          if (now - d[k] < 10000) count++;
        }
        onlineText.textContent = count + ' online';
        dot.classList.toggle('on', count > 0);
      });
  }, 4000);
}
</script>
