<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Note Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0b0f1a;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif
}
header{
  padding:14px;
  background:#020617;
  display:flex;
  gap:8px
}
input,select,button{
  background:#020617;
  border:1px solid #1e293b;
  color:#e5e7eb;
  padding:10px;
  border-radius:8px
}
button{cursor:pointer}
main{padding:14px}
#editor{
  min-height:200px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:12px;
  outline:none
}
#editor img{max-width:100%;border-radius:8px}
.history .item{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px
}
.actions button{margin-left:6px}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <input id="title" placeholder="Judul note">
  <select id="visibility">
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>
  <input id="password" class="hidden" placeholder="Password note">
  <button onclick="publish()">Generate</button>
</header>

<main>
  <div id="editor" contenteditable="true">Tulis catatan di sini...</div>

  <h3>History</h3>
  <div class="history" id="historyBox"></div>
</main>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://reglvenhbvmyqujoydil.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZ2x2ZW5oYnZteXF1am95ZGlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMzc2MDQsImV4cCI6MjA4MjgxMzYwNH0.h-UEIR98TT8TynjraSQi7iwUrnCQ0nLuFJKaHPbOSUc"
);

/* ================= PASSWORD TOGGLE ================= */
visibility.onchange = ()=>{
  password.classList.toggle('hidden', visibility.value!=='private');
};

/* ================= IMAGE PASTE SUPPORT ================= */
editor.addEventListener('paste',e=>{
  const items=(e.clipboardData||[]).items;
  for(const it of items){
    if(it.type.indexOf('image')!==-1){
      e.preventDefault();
      const file=it.getAsFile();
      const r=new FileReader();
      r.onload=()=>editor.innerHTML+=`<img src="${r.result}">`;
      r.readAsDataURL(file);
    }
  }
});

/* ================= PUBLISH ================= */
function uid(){
  return Math.random().toString(36).slice(2,10);
}

async function publish(){
  const id=uid();
  const data={
    id,
    title:title.value||'Untitled',
    content:editor.innerHTML,
    is_private:visibility.value==='private',
    password:password.value||''
  };

  await supabaseClient.from('notes').insert(data);

  alert("Note dibuat!");
  loadHistory();
}

/* ================= HISTORY ================= */
async function loadHistory(){
  const {data}=await supabaseClient
    .from('notes')
    .select('id,title,created_at')
    .order('created_at',{ascending:false});

  historyBox.innerHTML='';
  data.forEach(n=>{
    historyBox.innerHTML+=`
      <div class="item">
        <div>
          <b>${n.title}</b><br>
          <small>${new Date(n.created_at).toLocaleString()}</small>
        </div>
        <div class="actions">
          <button onclick="openNote('${n.id}')">View</button>
          <button onclick="delNote('${n.id}')">Hapus</button>
        </div>
      </div>`;
  });
}

function openNote(id){
  window.open(`view.html?id=${id}`,'_blank');
}

async function delNote(id){
  if(!confirm('Hapus note?'))return;
  await supabaseClient.from('notes').delete().eq('id',id);
  loadHistory();
}

loadHistory();
</script>

</body>
</html>
