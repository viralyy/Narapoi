<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>View Note</title>

<style>
*{box-sizing:border-box}
body{margin:0;background:#f3f4f6;font-family:system-ui}
.wrap{max-width:720px;margin:14px auto;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);overflow:hidden}
.header{padding:14px;border-bottom:1px solid #e5e7eb}
.header h2{margin:0;font-size:20px}
.meta{display:flex;gap:16px;font-size:13px;color:#555;margin-top:6px}
.meta span{display:flex;align-items:center;gap:6px}
.content{padding:14px;line-height:1.6}
.content img{max-width:100%;border-radius:6px}
.lock{padding:16px}
.lock input,.lock button{width:100%;padding:10px;margin-top:8px;border-radius:8px}
.lock button{background:#dc2626;color:#fff;border:none}
.actions{display:flex;gap:8px;padding:12px;border-top:1px solid #e5e7eb}
.actions button{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-weight:600;background:#f9fafb}
</style>
</head>

<body>

<div class="wrap">
  <div class="header">
    <h2 id="title">Loading...</h2>
    <div class="meta">
      <span><b id="views">0</b> views</span>
      <span><b id="online">0</b> online</span>
    </div>
  </div>

  <div id="lock" class="lock" style="display:none">
    <b>Note Private</b>
    <input id="pass" placeholder="Password">
    <button onclick="unlock()">Buka</button>
    <small id="err" style="color:red"></small>
  </div>

  <div id="content" class="content" style="display:none"></div>

  <div class="actions">
    <button onclick="copy()">Salin Link</button>
    <button onclick="share()">Share</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  "https://reglvenhbvmyqujoydil.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZ2x2ZW5oYnZteXF1am95ZGlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMzc2MDQsImV4cCI6MjA4MjgxMzYwNH0.h-UEIR98TT8TynjraSQi7iwUrnCQ0nLuFJKaHPbOSUc"
);

const id = new URLSearchParams(location.search).get('id');
const session = crypto.randomUUID();
let note;

/* ===== LOAD NOTE ===== */
async function load(){
  const {data,error} = await supabase
    .from('notes')
    .select('*')
    .eq('id',id)
    .maybeSingle();

  if(error || !data){
    document.body.innerHTML = 'NOT FOUND';
    return;
  }

  note = data;
  title.textContent = note.title;

  if(note.visibility === 'private'){
    lock.style.display = 'block';
  }else{
    show();
  }

  addView();
  joinOnline();
  refresh();
  realtime();
}

function show(){
  content.innerHTML = note.content;
  content.style.display = 'block';
}

/* ===== PASSWORD ===== */
function unlock(){
  if(pass.value === note.password){
    lock.style.display = 'none';
    show();
  }else{
    err.textContent = 'Password salah';
  }
}

/* ===== VIEWS ===== */
async function addView(){
  await supabase.from('views').insert({ note_id:id });
}

async function countViews(){
  const {count} = await supabase
    .from('views')
    .select('*',{count:'exact',head:true})
    .eq('note_id',id);

  views.textContent = count || 0;
}

/* ===== ONLINE ===== */
async function joinOnline(){
  await supabase.from('online_users').insert({
    note_id:id,
    session_id:session,
    last_seen:new Date().toISOString()
  });

  setInterval(()=>{
    supabase.from('online_users')
      .update({last_seen:new Date().toISOString()})
      .eq('session_id',session);
  },15000);
}

async function countOnline(){
  const {count} = await supabase
    .from('online_users')
    .select('*',{count:'exact',head:true})
    .eq('note_id',id)
    .gte('last_seen', new Date(Date.now()-30000).toISOString());

  online.textContent = count || 0;
}

/* ===== REALTIME ===== */
function realtime(){
  supabase.channel('note-'+id)
    .on('postgres_changes',{event:'INSERT',table:'views',filter:`note_id=eq.${id}`},countViews)
    .on('postgres_changes',{event:'INSERT',table:'online_users',filter:`note_id=eq.${id}`},countOnline)
    .on('postgres_changes',{event:'UPDATE',table:'online_users',filter:`note_id=eq.${id}`},countOnline)
    .subscribe();
}

function refresh(){
  countViews();
  countOnline();
}

/* ===== UTILS ===== */
function copy(){navigator.clipboard.writeText(location.href)}
function share(){navigator.share?.({title:note.title,url:location.href})}

load();
</script>
</body>
</html>
