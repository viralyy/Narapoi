<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>View Note</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0b0d12;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
.wrap{
  max-width:760px;
  margin:16px auto;
  padding:14px;
}
.card{
  background:#111827;
  border-radius:10px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
h1{
  font-size:22px;
  margin:0 0 6px;
  word-break:break-word;
}
.meta{
  display:flex;
  gap:12px;
  font-size:13px;
  color:#9ca3af;
  margin-bottom:14px;
}
.content{
  line-height:1.6;
  word-break:break-word;
}

/* ðŸ”¥ FIX CLICK */
.content,
.content *{
  pointer-events:auto !important;
}

/* IMAGE */
.content img{
  max-width:100%;
  height:auto;
  border-radius:8px;
  margin:10px 0;
}

/* SHARE */
.share{
  display:flex;
  gap:10px;
  margin-top:16px;
  flex-wrap:wrap;
}
.share button{
  flex:1;
  min-width:90px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#1f2937;
  color:#e5e7eb;
  font-weight:600;
  cursor:pointer;
}
.share button:hover{
  background:#374151;
}

/* PASSWORD */
.lock{
  text-align:center;
  padding:30px 10px;
}
.lock input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  margin:10px 0;
}
.lock button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
}

/* FOOT */
.footer{
  margin-top:16px;
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:#9ca3af;
}
</style>
</head>
<body>

<div class="wrap">
  <div class="card" id="app" style="display:none">
    <h1 id="title"></h1>
    <div class="meta">
      <span id="time"></span>
      <span>Views: <b id="views">0</b></span>
      <span>Online: <b id="online">0</b></span>
    </div>
    <div id="content" class="content"></div>

    <div class="share">
      <button onclick="shareWA()">WhatsApp</button>
      <button onclick="shareTG()">Telegram</button>
      <button onclick="copyLink()">Salin</button>
    </div>
  </div>

  <div class="card lock" id="lock" style="display:none">
    <h2>Private Note</h2>
    <input id="pass" type="password" placeholder="Password">
    <button onclick="unlock()">Buka</button>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, runTransaction, onDisconnect, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4KJsPLfoEiZSKQUZHrGzZh6-Fv_0Q7P0",
  authDomain: "views-counter-610fa.firebaseapp.com",
  databaseURL: "https://views-counter-610fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "views-counter-610fa",
  storageBucket: "views-counter-610fa.firebasestorage.app",
  messagingSenderId: "998762153750",
  appId: "1:998762153750:web:7113cd0bba422204fa7237"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

const id = new URLSearchParams(location.search).get('id');
const noteRef = ref(db, 'notes/'+id);

let currentNote=null;

get(noteRef).then(snap=>{
  if(!snap.exists()){
    document.body.innerHTML='<h2 style="text-align:center">Note tidak ditemukan</h2>';
    return;
  }
  currentNote=snap.val();

  if(currentNote.visibility==='private'){
    lock.style.display='block';
  }else{
    showNote();
  }
});

window.unlock=()=>{
  if(pass.value===currentNote.password){
    showNote();
  }else{
    alert('Password salah');
  }
};

function showNote(){
  lock.style.display='none';
  app.style.display='block';

  title.textContent=currentNote.title;
  time.textContent=currentNote.time;
  content.innerHTML=currentNote.content;

  initViews();
  initOnline();
}

/* VIEWS */
function initViews(){
  const vRef=ref(db,'views/'+id);
  runTransaction(vRef,(n)=>(n||0)+1);
  onValue(vRef,s=>views.textContent=s.val()||0);
}

/* ONLINE */
function initOnline(){
  const oRef=ref(db,'online/'+id+'/'+Math.random().toString(36).slice(2));
  set(oRef,1);
  onDisconnect(oRef).remove();
  onValue(ref(db,'online/'+id),s=>{
    online.textContent=s.exists()?Object.keys(s.val()).length:0;
  });
}

/* SHARE */
window.copyLink=()=>{
  navigator.clipboard.writeText(location.href);
  alert('Link disalin');
};
window.shareWA=()=>{
  open(`https://wa.me/?text=${encodeURIComponent(location.href)}`);
};
window.shareTG=()=>{
  open(`https://t.me/share/url?url=${encodeURIComponent(location.href)}`);
};
</script>

</body>
</html>
